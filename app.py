import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib import font_manager as fm 

# NOTE: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ Matplotlib ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà Streamlit Cloud ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
plt.rcParams['font.family'] = 'sans-serif'
plt.rcParams['font.sans-serif'] = ['DejaVu Sans'] 


st.set_page_config(page_title="Sun to Sort", layout="wide")

st.title("üåû Sun to Sort: ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÅ‡∏™‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏±‡∏î‡πÅ‡∏¢‡∏Å‡∏Ç‡∏¢‡∏∞")
st.caption("‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤‡∏¢ CalcTech Camp x CASIO | ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Python + Streamlit")

# ----------------------------
# ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Inputs)
# ----------------------------
col1, col2 = st.columns(2)
with col1:
    waste_type = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏¢‡∏∞‡∏´‡∏•‡∏±‡∏Å", ["‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å", "‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©", "‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå", "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"], index=1) # index=1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    waste_amount = st.number_input("‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏Ç‡∏¢‡∏∞‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°)", min_value=1.0, value=500.0)
    machine_count = st.number_input("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£", min_value=1, step=1, value=5)
    power_per_machine = st.number_input("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏ü‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (‡∏ß‡∏±‡∏ï‡∏ï‡πå)", min_value=100.0, value=500.0)

with col2:
    work_hours = st.number_input("‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", min_value=1.0, max_value=24.0, value=8.0)
    sunlight_hours = st.number_input("‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏î‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", min_value=1.0, max_value=12.0, value=5.0)
    panel_power = st.number_input("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ú‡∏á‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏á (‡∏ß‡∏±‡∏ï‡∏ï‡πå)", min_value=100.0, value=300.0)

# ----------------------------
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Real-time update)
# ----------------------------

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
energy_used = (machine_count * power_per_machine * work_hours) / 1000  # kWh per day
energy_per_panel = (panel_power * sunlight_hours * 0.75) / 1000        # kWh per panel per day (0.75 is assumed efficiency)
panels_needed = energy_used / energy_per_panel if energy_per_panel > 0 else 0
co2_saved = energy_used * 0.43 * 30  # kgCO‚ÇÇ/month (using 0.43 kgCO‚ÇÇ/kWh as assumed average)
total_energy_produced = energy_per_panel * panels_needed 

# ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Metrics)
st.subheader("üîç ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
st.metric("‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", f"{energy_used:.2f} kWh")
st.metric("‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏•‡∏¥‡∏ï‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏á‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô", f"{energy_per_panel:.2f} kWh")
st.metric("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ú‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ", f"{panels_needed:.1f} ‡πÅ‡∏ú‡∏á")
st.metric("‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", f"{co2_saved:.1f} kgCO‚ÇÇ")

# ----------------------------
# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏•‡πâ‡∏ß‡∏ô)
# ----------------------------
st.subheader("üìä Energy Comparison Chart") 
fig, ax = plt.subplots(figsize=(8, 4)) # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô

# [FIX] ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏£‡∏¥‡∏á: energy_used ‡πÅ‡∏•‡∏∞ total_energy_produced
categories = ["Energy Used", "Energy Produced"]
values = [energy_used, total_energy_produced]

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏ó‡πà‡∏á
ax.bar(categories, values, color=["#ffb703", "#219ebc"])

# [FIX] ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏•‡πâ‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå)
ax.set_ylabel("Energy (kWh)") 
ax.set_title("Actual Energy Use vs. Required Production") 

# [NOTE] ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ ‡∏≠‡∏≤‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô Grid
ax.grid(axis='y', linestyle='--', alpha=0.7)

st.pyplot(fig) # ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏£‡∏≤‡∏ü

# ----------------------------
# ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô CSV
# ----------------------------
df = pd.DataFrame({
    "Item": ["Actual Energy Use", "Total Energy Produced", "Panels Needed", "CO2 Saved (kg/month)"], 
    "Value": [energy_used, total_energy_produced, panels_needed, co2_saved]
})

st.download_button(
    label="üì• Download Results (CSV)", 
    data=df.to_csv(index=False).encode('utf-8'),
    file_name="sun_to_sort_result.csv",
    mime="text/csv",
)

st.info("üí° ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏î‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏ú‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå")
